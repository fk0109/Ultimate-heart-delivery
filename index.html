<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ultimate Heart Delivery üíñ</title>

  <style>
    body{
      margin:0;
      background:linear-gradient(135deg,#fff0f6,#ffffff);
      overflow:hidden;
      font-family:'Comic Sans MS', cursive;
      text-align:center;
      transition:0.3s;
    }

    /* ‚úÖ CHAOS MODE = BLACK BACKGROUND */
    body.chaos{
      background:black !important;
    }

    /* ‚úÖ CHAOS TEXT */
    #chaosText{
      position:fixed;
      top:40%;
      left:50%;
      transform:translate(-50%,-50%);
      font-size:70px;
      font-weight:bold;
      color:red;
      display:none;
      z-index:999;
      animation:pulse 0.5s infinite;
      pointer-events:none;
    }
    @keyframes pulse{
      0%{ transform:translate(-50%,-50%) scale(1); }
      50%{ transform:translate(-50%,-50%) scale(1.1); }
      100%{ transform:translate(-50%,-50%) scale(1); }
    }

    /* ‚úÖ START SCREEN */
    #startScreen{
      position:fixed;
      width:100%;
      height:100%;
      background:linear-gradient(135deg,#ffd6e7,#ffffff);
      display:flex;
      flex-direction:column;
      justify-content:center;
      align-items:center;
      z-index:10;
      padding:20px;
      gap:10px;
    }

    /* ‚úÖ END SCREEN CENTER */
    #endScreen{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.85);
      display:none;
      justify-content:center;
      align-items:center;
      z-index:1000;
    }

    #endBox{
      background:#111;
      padding:40px 60px;
      border-radius:25px;
      box-shadow:0 0 40px hotpink;
      color:white;
      text-align:center;
      max-width:90vw;
    }

    #endBox h2{
      font-size:40px;
      margin:0;
    }

    #endBox p{
      font-size:26px;
      margin:15px 0;
      line-height:1.4;
    }

    .startBtn{
      padding:15px 35px;
      font-size:22px;
      border:none;
      border-radius:40px;
      background:#ff69b4;
      color:white;
      cursor:pointer;
    }
    .startBtn:active{
      transform:scale(0.98);
    }

    #topbar{
      display:flex;
      justify-content:space-around;
      font-size:18px;
      color:#ff1493;
      margin-bottom:8px;
    }

    #gameArea{
      position:relative;
      width:100%;
      height:75vh;
      overflow:hidden;
    }

    /* ‚úÖ HEART SIZE 1.5x */
    .object{
      position:absolute;
      font-size:42px; /* 28 x 1.5 */
      animation:fall linear;
      will-change:transform;
      user-select:none;
    }

    .object img{
      width:100px;
      height:100px;
      user-select:none;
      pointer-events:none;
    }

    @keyframes fall{
      from{ top:-50px; }
      to{ top:100vh; }
    }

    #basket{
      position:absolute;
      bottom:20px;
      left:50%;
      transform:translateX(-50%);
      font-size:100px;
      pointer-events:none;
      user-select:none;
    }

    /* ‚úÖ optional small debug text */
    #audioStatus{
      font-size:14px;
      color:#ff1493;
      opacity:0.85;
      margin-top:6px;
    }
  </style>
</head>

<body>
  <div id="chaosText">üî• CHAOS MODE üî•</div>

  <div id="startScreen">
    <h1>üíñ Ultimate Heart Delivery üíñ</h1>
    <p>üíó +1 | üíõ +5 | üíî -10 | Special Object +50</p>
    <p>The last 10 seconds = üî• CHAOS MODE üî•</p>
    <p>Total Time: 60 seconds</p>
    <button class="startBtn" onclick="startGame()">Start Game</button>
    <div id="audioStatus"></div>
  </div>

  <h1>Catch the Hearts üíñ</h1>

  <div id="topbar">
    <div>Score: <span id="score">0</span></div>
    <div>Time: <span id="time">60</span>s</div>
  </div>

  <div id="gameArea">
    <div id="basket">üß∫</div>
  </div>

  <!-- ‚úÖ END SCREEN -->
  <div id="endScreen">
    <div id="endBox">
      <h2>üíò Round Complete!</h2>
      <p id="finalScore"></p>
      <button class="startBtn" onclick="location.reload()">Play Again</button>
    </div>
  </div>

  <!-- ‚úÖ IMPORTANT: audio MUST be in HTML (NOT in CSS) -->
  <!-- ‚úÖ Use ./ for GitHub Pages relative path -->
  <audio id="bgm" src="./bgm.mp3" loop preload="auto"></audio>
  <audio id="bonusSound" src="./bonus.mp3" preload="auto"></audio>

  <script>
    let score=0;
    let totalTime=60;
    let timeLeft=60;
    let specialCount=0;
    let chaosMode=false;

    const basket=document.getElementById("basket");
    const scoreDisplay=document.getElementById("score");
    const timeDisplay=document.getElementById("time");
    const finalScore=document.getElementById("finalScore");
    const gameArea=document.getElementById("gameArea");
    const bonusSound=document.getElementById("bonusSound");
    const bgm=document.getElementById("bgm");
    const chaosText=document.getElementById("chaosText");
    const endScreen=document.getElementById("endScreen");
    const audioStatus=document.getElementById("audioStatus");

    let gameRunning=false;
    let heartInterval=null;
    let specialInterval=null;
    let countdownInterval=null;

    function setAudioStatus(msg){
      if(!audioStatus) return;
      audioStatus.textContent = msg || "";
    }

    async function safePlay(audioEl, label){
      if(!audioEl) return false;
      try{
        // ‡∏ö‡∏≤‡∏á browser ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å user gesture -> startGame() ‡∏Ñ‡∏∑‡∏≠ click ‡πÅ‡∏•‡πâ‡∏ß
        audioEl.muted = false;
        const p = audioEl.play();
        if(p && typeof p.then === "function"){
          await p;
        }
        return true;
      }catch(err){
        console.log(label + " play blocked/error:", err);
        return false;
      }
    }

    /* ‚úÖ Start */
    async function startGame(){
      document.getElementById("startScreen").style.display="none";
      gameRunning=true;

      // ‚úÖ START BGM on user gesture (click Start)
      bgm.volume = 0.45;
      const ok = await safePlay(bgm, "BGM");
      setAudioStatus(ok ? "üîä Sound ON" : "üîá Sound blocked (browser policy)");

      startCountdown();
      heartInterval = setInterval(createHeart, 300);
      specialInterval = setInterval(createSpecial, 700);
    }

    /* ‚úÖ Mouse Control */
    document.addEventListener("mousemove", function(e){
      if(!gameRunning) return;
      basket.style.left = e.clientX + "px";
    });

    /* ‚úÖ Touch Control (mobile) */
    document.addEventListener("touchmove", function(e){
      if(!gameRunning) return;
      if(!e.touches || !e.touches[0]) return;
      basket.style.left = e.touches[0].clientX + "px";
    }, { passive: true });

    /* ‚úÖ Create Hearts */
    function createHeart(){
      if(!gameRunning) return;

      const obj = document.createElement("div");
      obj.className = "object";

      const type = Math.random();
      let value = 1;

      if(type < 0.15){ obj.textContent = "üíõ"; value = 5; }
      else if(type < 0.30){ obj.textContent = "üíî"; value = -10; }
      else{ obj.textContent = "üíó"; }

      obj.style.left = (Math.random() * window.innerWidth) + "px";

      const speed = chaosMode ? 1 : (3 - (timeLeft / totalTime) * 1.5);
      obj.style.animationDuration = speed + "s";

      gameArea.appendChild(obj);
      collisionCheck(obj, value, false);
    }

    /* ‚úÖ Special */
    function createSpecial(){
      if(!gameRunning) return;
      if(Math.random() > 0.08) return;

      const obj = document.createElement("div");
      obj.className = "object";
      obj.innerHTML = '<img src="./special.png" alt="special">';
      obj.style.left = (Math.random() * window.innerWidth) + "px";
      obj.style.animationDuration = "2s";

      gameArea.appendChild(obj);
      collisionCheck(obj, 50, true);
    }

    /* ‚úÖ Collision */
    function collisionCheck(obj, value, isSpecial){
      const check = setInterval(async ()=>{
        if(!obj.isConnected){
          clearInterval(check);
          return;
        }

        const o = obj.getBoundingClientRect();
        const b = basket.getBoundingClientRect();

        if(o.bottom >= b.top && o.left < b.right && o.right > b.left){
          score += value;
          if(score < 0) score = 0;
          scoreDisplay.innerText = score;

          if(isSpecial){
            specialCount++;

            // ‚úÖ Bonus sound (also safePlay for policy / errors)
            bonusSound.currentTime = 0;
            await safePlay(bonusSound, "BONUS");
          }

          obj.remove();
          clearInterval(check);
          return;
        }

        if(o.top > window.innerHeight){
          obj.remove();
          clearInterval(check);
        }
      }, 30);
    }

    /* ‚úÖ Countdown */
    function startCountdown(){
      countdownInterval = setInterval(()=>{
        if(!gameRunning){
          clearInterval(countdownInterval);
          return;
        }

        timeLeft--;
        timeDisplay.innerText = timeLeft;

        if(timeLeft === 10) activateChaos();

        if(timeLeft <= 0){
          gameRunning = false;
          clearInterval(countdownInterval);
          endGame();
        }
      }, 1000);
    }

    /* ‚úÖ Chaos */
    function activateChaos(){
      chaosMode = true;
      document.body.classList.add("chaos");
      chaosText.style.display = "block";

      if(heartInterval) clearInterval(heartInterval);
      heartInterval = setInterval(createHeart, 100);
    }

    /* ‚úÖ End Game */
    function endGame(){
      chaosText.style.display = "none";
      document.body.classList.remove("chaos");

      // stop intervals
      if(heartInterval) clearInterval(heartInterval);
      if(specialInterval) clearInterval(specialInterval);

      // stop audio
      try{
        bgm.pause();
        bgm.currentTime = 0;
      }catch(e){}

      finalScore.innerHTML =
        "Final Score: " + score +
        "<br>Special Collected: " + specialCount +
        "<br>Total Time: " + totalTime + " seconds";

      endScreen.style.display = "flex";
    }

    // ‚úÖ Extra: if browser blocks until first interaction, try to "unlock" audio
    // (harmless; safePlay already handles errors)
    document.addEventListener("click", () => {
      if(gameRunning && bgm && bgm.paused){
        safePlay(bgm, "BGM(retry)");
      }
    }, { once: false });
  </script>
</body>
</html>
